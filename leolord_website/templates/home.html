{% extends "base.html" %}
{% block content %}
<div class="home-content">
    <h1>Leolord</h1>
    <form method="POST">
        <label for="videoUrl">Video URL:</label>
        <input type="text" id="videoUrl" name="videoUrl" value="{{ video_url }}">
        <button type="submit">Set Video</button>
    </form>
    <div id="background-video"></div>
    <button id="mute-button" class="mute-button" onclick="toggleMute()">
        Mute
    </button>
</div>
<script>
const videoUrl = "{{ video_url }}";
let playerReady = false;

function onYouTubeIframeAPIReady() {
  const videoId = videoUrl ? getYouTubeVideoId(videoUrl) : "";
  player = new YT.Player("background-video", {
    videoId: videoId,
    playerVars: {
      autoplay: 0, // Disable autoplay initially
      controls: 0,
      mute: 0,
      loop: 1,
      playlist: videoId,
      enablejsapi: 1,
      modestbranding: 1,
      showinfo: 0,
      rel: 0,
      iv_load_policy: 3,
    },
    events: {
      onReady: onPlayerReady,
    },
  });
}

function onPlayerReady(event) {
  event.target.setPlaybackQuality("hd1080p");
  playerReady = true;
  checkForNewVideo(); // Call checkForNewVideo when the player is ready
}

// Add the toggleMute function
function toggleMute() {
  const muteButton = document.getElementById("mute-button");
  if (player.isMuted()) {
    player.unMute();
    muteButton.textContent = "Mute";
  } else {
    player.mute();
    muteButton.textContent = "Unmute";
  }
}

function getYouTubeVideoId(url) {
    if (!url) {
    return null;
    }
  const regex = /(?:https?:\/\/)?(?:www\.)?youtu(?:\.be\/|be\.com\/watch\?v=)([\w-]+)/;
  const matches = url.match(regex);
  return matches ? matches[1] : null;
}

function checkForNewVideo() {
  if (!playerReady) {
    return;
  }

  fetch("/get_playback_info")
    .then((response) => response.json())
    .then((data) => {
      const newVideoUrl = data.video_url;
      const newPlaybackTime = data.playback_time;

      console.log("Fetched playback info:", data); // Add a console log here

      if (newVideoUrl !== videoUrl) {
        const videoId = getYouTubeVideoId(newVideoUrl);
        if (videoId) {
          player.loadVideoById({ videoId: videoId, startSeconds: newPlaybackTime });
          videoUrl = newVideoUrl;
        }
      } else {
        const currentTime = player.getCurrentTime();
        const timeDifference = Math.abs(currentTime - newPlaybackTime);

        if (timeDifference > 2) {
          console.log("Resyncing video time"); // Add a console log here
          player.seekTo(newPlaybackTime);
        }
      }
    })
    .catch((error) => {
      console.error("Error fetching playback info:", error);
    });
}

// Check for a new video every 5 seconds
setInterval(checkForNewVideo, 5000);


// Check for a new video every 10 seconds
setInterval(checkForNewVideo, 5000);
function updateServerPlaybackInfo() {
    const clientPlaybackTime = player.getCurrentTime();
  
    // Send the current playback time to the server
    fetch("/get_playback_info", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `playback_time=${clientPlaybackTime}`,
    });
  }
  
  function syncClientPlaybackInfo() {
    fetch("/get_playback_info")
      .then((response) => response.json())
      .then((data) => {
        const serverPlaybackTime = data.playback_time;
        const clientPlaybackTime = player.getCurrentTime();
  
        // If the difference between the server and client playback times is greater than a small threshold (e.g., 1 second), update the client's playback time
        if (Math.abs(serverPlaybackTime - clientPlaybackTime) > 1) {
          player.seekTo(serverPlaybackTime, true);
        }
      })
      .catch((error) => {
        console.error("Error fetching playback info:", error);
      });
  }
  
  // Call updateServerPlaybackInfo every 5 seconds
  setInterval(updateServerPlaybackInfo, 5000);
  
  // Call syncClientPlaybackInfo every 10 seconds
  setInterval(syncClientPlaybackInfo, 10000);

</script>
<script src="https://www.youtube.com/iframe_api"></script>
<!-- <script src="{{ url_for('static', filename='js/yt-player.js') }}"></script> -->
{% endblock %}
